import argparse
from pathlib import Path
import json

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('--results', type=str, required=True, help='Path to results generated by process_results.py')
    args = parser.parse_args()

    with open(Path(args.results)/'complete.json', 'r') as f:
        results = json.load(f)
    
    abs_ng = {}
    abs_ap = {}
    best_ng = {}
    best_ap = {}
    baseline = ''
    for mode in results.keys():
        if mode.startswith('baseline'):
            baseline = mode
            break
    N = 0
    K = 4
    for mode, sub_res in results.items():
        ng_imp = 0
        ap_imp = 0
        ng_it = 0
        ap_it = 0
        ng_dicoder_better = 0
        ap_dicoder_better = 0
        abs_ng[mode] = [(0, 0)] * K
        abs_ap[mode] = [(0, 0)] * K
        best_ng[mode] = [0.0] * K
        best_ap[mode] = [0.0] * K
        N = max(N, len(sub_res))
        for id, res in sub_res.items():
            if id == 0:
                continue
            ngram = [float(x[0]) for x in res]
            best_temp = 0.0
            for i in range(len(ngram)):
                abs_ng[mode][i] = (abs_ng[mode][i][0] + ngram[i], abs_ng[mode][i][1] + 1)
                best_temp = max(best_temp, ngram[i])
                best_ng[mode][i] += best_temp
            api = [float(x[1]) for x in res]
            best_temp = 0.0
            for i in range(len(api)):
                abs_ap[mode][i] = (abs_ap[mode][i][0] + api[i], abs_ap[mode][i][1] + 1)
                best_temp = max(best_temp, api[i])
                best_ap[mode][i] += best_temp
            ng_count = 0
            ap_count = 0
            for i in range(1, len(res)):
                if ngram[i] > ngram[i-1]:
                    ng_count += 1
                if api[i] > api[i-1]:
                    ap_count += 1
            if not mode.startswith('baseline'):
                if ngram[-1] > float(results[baseline][id][0][0]):
                    ng_dicoder_better += 1
                if api[-1] > float(results[baseline][id][0][1]):
                    ap_dicoder_better += 1
            if ng_count > 0:
                ng_imp += 1
            if ap_count > 0:
                ap_imp += 1
            if ng_count > 1:
                ng_it += 1
            if ap_count > 1:
                ap_it += 1
        print(f'For mode {mode} with {N} data points:')
        print(f'N-gram improvement: {ng_imp}')
        print(f'API improvement: {ap_imp}')
        print(f'N-gram improvement (iterative): {ng_it}')
        print(f'API improvement (iterative): {ap_it}')
        if not mode.startswith('baseline'):
            print(f'N-gram improvement (dicoder better): {ng_dicoder_better}')
            print(f'API improvement (dicoder better): {ap_dicoder_better}')
        print(f'N-gram similarity (absolute): {[(i[0]/i[1]) if i[1] > 0 else 0 for i in abs_ng[mode]]}')
        print(f'API similarity (absolute): {[(i[0]/i[1]) if i[1] > 0 else 0 for i in abs_ap[mode]]}')
        res_best_ng = [str(i/N) for i in best_ng[mode]]
        res_best_ap = [str(i/N) for i in best_ap[mode]]
        print(f'N-gram similarity (best): {res_best_ng}')
        print(f'API similarity (best): {res_best_ap}')
        if mode.startswith('baseline'):
            baseline_line = [res_best_ng[0], res_best_ap[0], str(N)]
        else:
            output_line = [mode, args.results.split('/')[-1]] + [str(i[0]/i[1]) if i[1] > 0 else '0' for i in abs_ng[mode]] + res_best_ng + [str(i[0]/i[1]) if i[1] > 0 else '0' for i in abs_ap[mode]] + res_best_ap
    output_line = output_line[:7] + [baseline_line[0]] + output_line[7:] + baseline_line[1:]
    with open(Path(args.results)/'spreadsheet.csv', 'w') as f:
        f.write(', '.join(output_line) + '\n')
